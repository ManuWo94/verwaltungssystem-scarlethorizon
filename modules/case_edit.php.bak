<?php
/**
 * Aktenverwaltungssystem - Department of Justice
 * Fallbearbeitungsmodul
 * 
 * Dieses Modul ermöglicht die Bearbeitung von Falldaten und Klageschriften.
 */

session_start();
require_once '../includes/functions.php';
require_once '../includes/db.php';
require_once '../includes/auth.php';

// Überprüfe, ob der Benutzer angemeldet ist
if (!isset($_SESSION['user_id'])) {
    header('Location: ../login.php');
    exit;
}

$user_id = $_SESSION['user_id'];
$username = $_SESSION['username'];
$role = $_SESSION['role'];
$message = '';
$error = '';

// Id des zu bearbeitenden Falls aus der URL erhalten
$caseId = isset($_GET['id']) ? $_GET['id'] : null;
$action = isset($_GET['action']) ? $_GET['action'] : null;

// Überprüfe, ob die ID gültig ist
if (!$caseId) {
    header('Location: cases.php');
    exit;
}

// Fall aus der Datenbank laden
$caseData = findById('cases.json', $caseId);

// Überprüfen, ob der Fall existiert
if (!$caseData) {
    $error = 'Fall nicht gefunden.';
    header('Location: cases.php');
    exit;
}

// Verarbeite GET parameter 'action' für direkte Aktionen
if ($action === 'close_case') {
    // Überprüfe Berechtigungen für den Benutzer - Staatsanwälte und Führungskräfte
    $userRole = strtolower($_SESSION['role']); 
    $isProsecutor = ($userRole == 'prosecutor' || $userRole == 'staatsanwalt' || 
                 $userRole == 'district attorney' || $userRole == 'bezirksstaatsanwalt' ||
                 $userRole == 'attorney general' || $userRole == 'generalstaatsanwalt');
    
    $isLeadership = ($userRole == 'chief justice' || $userRole == 'oberster richter' ||
                    $userRole == 'senior associate justice' || $userRole == 'stellvertretender oberster richter' ||
                    $userRole == 'administrator');
    
    // Debug-Info
    error_log("Zugriffsprüfung für Fall schließen - Rolle: " . $_SESSION['role'] . 
              ", isProsecutor: " . ($isProsecutor ? "true" : "false") . 
              ", isLeadership: " . ($isLeadership ? "true" : "false"));
    
    if ($isProsecutor || $isLeadership) {
        // Zeige ein Formular an, um den Fall zu schließen
        $showCloseForm = true;
    } else {
        // Keine Berechtigung - zurück zur Fallübersicht
        header("Location: ../access_denied.php");
        exit;
    }
}

// Überprüfe die Verjährung des Falls und aktualisiere, falls nötig
$caseData = checkCaseExpiration($caseData);

// Finden der vorhandenen Klageschrift für diesen Fall
$existingIndictment = null;
$indictments = getJsonData('indictments.json');
foreach ($indictments as $indictment) {
    if ($indictment['case_id'] === $caseId) {
        $existingIndictment = $indictment;
        break;
    }
}

// Verarbeitung von Formularübermittlungen
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Fallaktualisierung (grundlegende Informationen)
    if (isset($_POST['action']) && $_POST['action'] === 'update_case') {
        $defendant = sanitize($_POST['defendant'] ?? '');
        $charge = sanitize($_POST['charge'] ?? '');
        $incidentDate = sanitize($_POST['incident_date'] ?? '');
        $district = sanitize($_POST['district'] ?? '');
        $prosecutorName = sanitize($_POST['prosecutor'] ?? '');
        $judgeName = sanitize($_POST['judge'] ?? '');
        $notes = sanitize($_POST['notes'] ?? '');
        $bailAmount = sanitize($_POST['bail_amount'] ?? '');
        $witnesses = sanitize($_POST['witnesses'] ?? '');
        $victims = sanitize($_POST['victims'] ?? '');
        
        // Verjährungsdatum berechnen (standardmäßig 21 Tage nach Vorfalldatum)
        $expirationDays = 21;
        $expirationDate = date('Y-m-d', strtotime($incidentDate . " +{$expirationDays} days"));
        
        // Validierung
        if (empty($defendant) || empty($charge) || empty($incidentDate) || empty($district)) {
            $error = 'Bitte füllen Sie alle Pflichtfelder aus.';
        } else {
            // Fall aktualisieren
            $updatedCase = $caseData;
            $updatedCase['defendant'] = $defendant;
            $updatedCase['charge'] = $charge;
            $updatedCase['incident_date'] = $incidentDate;
            $updatedCase['expiration_date'] = $expirationDate;
            $updatedCase['district'] = $district;
            $updatedCase['prosecutor'] = $prosecutorName;
            $updatedCase['judge'] = $judgeName;
            $updatedCase['notes'] = $notes;
            $updatedCase['bail_amount'] = $bailAmount;
            $updatedCase['witnesses'] = $witnesses;
            $updatedCase['victims'] = $victims;
            $updatedCase['date_updated'] = date('Y-m-d H:i:s');
            
            if (updateRecord('cases.json', $caseId, $updatedCase)) {
                $message = 'Fall wurde erfolgreich aktualisiert.';
                $caseData = $updatedCase; // Aktualisiere die Daten für die Anzeige
            } else {
                $error = 'Fehler beim Aktualisieren des Falls.';
            }
        }
    }
    // Revisionsantrag
    elseif (isset($_POST['action']) && $_POST['action'] === 'request_revision') {
        $revisionReason = sanitize($_POST['revision_reason'] ?? '');
        
        if (empty($revisionReason)) {
            $error = 'Bitte geben Sie einen Grund für die Revision an.';
        } else {
            $updatedCase = $caseData;
            
            // Status auf "Revision beantragt" setzen
            $updatedCase['status'] = 'revision_requested';
            $updatedCase['revision_requested_by'] = $username;
            $updatedCase['revision_requested_date'] = date('Y-m-d H:i:s');
            $updatedCase['revision_reason'] = $revisionReason;
            
            // Notiz hinzufügen
            $revisionNote = "Revision beantragt von " . $username . " am " . date('d.m.Y H:i:s');
            $updatedCase['notes'] = (!empty($updatedCase['notes'])) 
                ? $revisionNote . "\n\n" . $updatedCase['notes'] 
                : $revisionNote;
            
            if (updateRecord('cases.json', $caseId, $updatedCase)) {
                $message = 'Revisionsantrag wurde erfolgreich eingereicht.';
                $caseData = $updatedCase; // Aktualisiere die Daten für die Anzeige
            } else {
                $error = 'Fehler beim Einreichen des Revisionsantrags.';
            }
        }
    }
    // Klageschrift einreichen
    elseif (isset($_POST['action']) && $_POST['action'] === 'submit_indictment') {
        $indictmentText = sanitize($_POST['indictment_text'] ?? '');
        
        if (empty($indictmentText)) {
            $error = 'Die Klageschrift darf nicht leer sein.';
        } else {
            // Ersetze Signatur-Platzhalter mit tatsächlicher Signatur
            $currentUser = getUserById($user_id);
            $signature = getUserSignature($currentUser);
            $indictmentText = str_replace('{{SIGNATURE}}', $signature, $indictmentText);
            
            $updatedCase = $caseData;
            
            // Fallstatus aktualisieren
            $updatedCase['status'] = 'pending';
            $updatedCase['prosecutor'] = $username;
            
            // Speichere die Klageschrift
            $indictmentData = [
                'case_id' => $caseId,
                'content' => $indictmentText,
                'prosecutor_id' => $user_id,
                'prosecutor_name' => $username,
                'status' => 'pending',
                'date_created' => date('Y-m-d H:i:s')
            ];
            
            // Notiz zum Fall hinzufügen
            $indictmentNote = "Klageschrift eingereicht von " . $username . " am " . date('d.m.Y H:i:s');
            $updatedCase['notes'] = (!empty($updatedCase['notes'])) 
                ? $indictmentNote . "\n\n" . $updatedCase['notes'] 
                : $indictmentNote;
            
            // Die insertRecord-Funktion gibt die ID zurück, wenn erfolgreich
            $indictmentId = insertRecord('indictments.json', $indictmentData);
            
            if ($indictmentId && updateRecord('cases.json', $caseId, $updatedCase)) {
                $message = 'Klageschrift wurde erfolgreich eingereicht.';
                
                // Aktualisiere Fall-Daten und Klageschrift-Daten
                $caseData = $updatedCase;
                $existingIndictment = findById('indictments.json', $indictmentId);
                
                // Weiterleitung zur Fallübersicht nach erfolgreicher Einreichung
                header('Location: cases.php');
                exit;
            } else {
                $error = 'Fehler beim Einreichen der Klageschrift.';
            }
        }
    }
    // Aktenzeichen aktualisieren
    elseif (isset($_POST['action']) && $_POST['action'] === 'update_case_id') {
        $newCaseId = sanitize($_POST['new_case_id'] ?? '');
        
        if (empty($newCaseId)) {
            $error = 'Das neue Aktenzeichen darf nicht leer sein.';
        } else {
            // Prüfen, ob das neue Aktenzeichen bereits existiert
            $existingCase = findById('cases.json', $newCaseId);
            if ($existingCase) {
                $error = 'Ein Fall mit diesem Aktenzeichen existiert bereits.';
            } else {
                // Speichere den alten Case-ID für Updates bei verknüpften Daten
                $oldCaseId = $caseId;
                
                // Aktualisiere den Case selbst
                $updatedCase = $caseData;
                $updatedCase['id'] = $newCaseId;
                $updatedCase['date_updated'] = date('Y-m-d H:i:s');
                
                // Erstelle neuen Datensatz mit neuer ID und lösche den alten
                if (insertRecord('cases.json', $updatedCase) && deleteRecord('cases.json', $oldCaseId)) {
                    // Aktualisiere Verweise in anderen Tabellen (z.B. Klageschriften)
                    if ($existingIndictment) {
                        $existingIndictment['case_id'] = $newCaseId;
                        updateRecord('indictments.json', $existingIndictment['id'], $existingIndictment);
                    }
                    
                    $message = 'Aktenzeichen wurde erfolgreich aktualisiert.';
                    
                    // Weiterleitung zur neuen Case-ID
                    header('Location: case_edit.php?id=' . $newCaseId);
                    exit;
                } else {
                    $error = 'Fehler beim Aktualisieren des Aktenzeichens.';
                }
            }
        }
    }
    // Außergerichtlicher Deal
    elseif (isset($_POST['action']) && $_POST['action'] === 'settlement') {
        $settlementDetails = sanitize($_POST['settlement_details'] ?? '');
        
        if (empty($settlementDetails)) {
            $error = 'Die Details des außergerichtlichen Deals dürfen nicht leer sein.';
        } else {
            $updatedCase = $caseData;
            
            // Status auf "abgeschlossen" setzen
            $updatedCase['status'] = 'completed';
            $updatedCase['is_closed'] = true;
            $updatedCase['closed_date'] = date('Y-m-d H:i:s');
            $updatedCase['closed_reason'] = 'Außergerichtlicher Deal';
            $updatedCase['settlement_details'] = $settlementDetails;
            
            // Notiz hinzufügen
            $settlementNote = "Außergerichtlicher Deal abgeschlossen von " . $username . " am " . date('d.m.Y H:i:s');
            $updatedCase['notes'] = (!empty($updatedCase['notes'])) 
                ? $settlementNote . "\n\n" . $updatedCase['notes'] 
                : $settlementNote;
            
            if (updateRecord('cases.json', $caseId, $updatedCase)) {
                $message = 'Außergerichtlicher Deal wurde erfolgreich registriert.';
                $caseData = $updatedCase; // Aktualisiere die Daten für die Anzeige
                
                // Wenn eine Klageschrift existiert, aktualisiere auch diese
                if ($existingIndictment) {
                    $existingIndictment['status'] = 'completed';
                    $existingIndictment['settlement'] = true;
                    $existingIndictment['settlement_details'] = $settlementDetails;
                    $existingIndictment['settlement_date'] = date('Y-m-d H:i:s');
                    $existingIndictment['settlement_by'] = $username;
                    
                    updateRecord('indictments.json', $existingIndictment['id'], $existingIndictment);
                }
                
                // Weiterleitung zur Fallübersicht nach erfolgreicher Eintragung
                header('Location: cases.php');
                exit;
            } else {
                $error = 'Fehler beim Registrieren des außergerichtlichen Deals.';
            }
        }
    }
    // Fall schließen
    elseif (isset($_POST['action']) && $_POST['action'] === 'close_case') {
        $closingReason = sanitize($_POST['closing_reason'] ?? '');
        
        if (empty($closingReason)) {
            $error = 'Bitte geben Sie einen Grund für die Schließung des Falls an.';
        } else {
            $updatedCase = $caseData;
            
            // Status auf "abgeschlossen" setzen
            $updatedCase['status'] = 'completed';
            $updatedCase['is_closed'] = true;
            $updatedCase['closed_date'] = date('Y-m-d H:i:s');
            $updatedCase['closed_reason'] = $closingReason;
            
            // Notiz hinzufügen
            $closingNote = "Fall geschlossen von " . $username . " am " . date('d.m.Y H:i:s') . ". Grund: " . $closingReason;
            $updatedCase['notes'] = (!empty($updatedCase['notes'])) 
                ? $closingNote . "\n\n" . $updatedCase['notes'] 
                : $closingNote;
            
            if (updateRecord('cases.json', $caseId, $updatedCase)) {
                $message = 'Fall wurde erfolgreich geschlossen.';
                $caseData = $updatedCase; // Aktualisiere die Daten für die Anzeige
                
                // Wenn eine Klageschrift existiert, aktualisiere auch diese
                if ($existingIndictment) {
                    $existingIndictment['status'] = 'completed';
                    $existingIndictment['closing_reason'] = $closingReason;
                    $existingIndictment['closed_date'] = date('Y-m-d H:i:s');
                    $existingIndictment['closed_by'] = $username;
                    
                    updateRecord('indictments.json', $existingIndictment['id'], $existingIndictment);
                }
                
                // Weiterleitung zur Fallübersicht nach erfolgreicher Schließung
                header('Location: cases.php');
                exit;
            } else {
                $error = 'Fehler beim Schließen des Falls.';
            }
        }
    }
    // Urteil zum Fall hinzufügen
    elseif (isset($_POST['action']) && $_POST['action'] === 'add_verdict') {
        $verdictText = sanitize($_POST['verdict_text'] ?? '');
        $verdictDate = sanitize($_POST['verdict_date'] ?? '');
        $verdictStatus = sanitize($_POST['verdict_status'] ?? 'completed');
        
        if (empty($verdictText)) {
            $error = 'Der Urteilsspruch darf nicht leer sein.';
        } else {
            $updatedCase = $caseData;
            $updatedCase['status'] = $verdictStatus;
            $updatedCase['verdict'] = $verdictText;
            $updatedCase['verdict_date'] = $verdictDate;
            $updatedCase['verdict_by'] = $user_id;
            
            // Notiz zum Fall hinzufügen
            $verdictNote = "Urteil hinzugefügt von " . $username . " am " . date('d.m.Y H:i:s') . "\n";
            $verdictNote .= "Urteilsstatus: " . mapStatusToGerman($verdictStatus);
            
            $updatedCase['notes'] = (!empty($updatedCase['notes'])) 
                ? $verdictNote . "\n\n" . $updatedCase['notes'] 
                : $verdictNote;
            
            // Aktualisiere auch alle zugehörigen Klageschriften
            $indictments = loadJsonData('indictments.json');
            $updatedIndictments = [];
            
            foreach ($indictments as $indictment) {
                if (isset($indictment['case_id']) && $indictment['case_id'] === $caseId) {
                    // Update status nur für angenommene Klageschriften
                    if ($indictment['status'] === 'accepted' || $indictment['status'] === 'scheduled') {
                        $indictment['status'] = 'completed';
                        $indictment['verdict'] = $verdictText;
                        $indictment['verdict_date'] = $verdictDate;
                    }
                }
                $updatedIndictments[] = $indictment;
            }
            
            // Speichere aktualisierte Klageschriften
            saveJsonData('indictments.json', $updatedIndictments);
            
            if (updateRecord('cases.json', $caseId, $updatedCase)) {
                $message = 'Urteil wurde erfolgreich hinzugefügt.';
                $caseData = $updatedCase;
                
                // Weiterleitung zur Fallansicht nach erfolgreichem Hinzufügen des Urteils
                header('Location: case_view.php?id=' . $caseId);
                exit;
            } else {
                $error = 'Fehler beim Hinzufügen des Urteils.';
            }
        }
    }
    // Revisionsurteil eintragen
    elseif (isset($_POST['action']) && $_POST['action'] === 'add_revision_verdict') {
        $revisionVerdictText = sanitize($_POST['revision_verdict_text'] ?? '');
        $revisionVerdictDate = sanitize($_POST['revision_verdict_date'] ?? date('Y-m-d'));
        $revisionVerdictStatus = sanitize($_POST['revision_verdict_status'] ?? 'completed');
        
        if (empty($revisionVerdictText)) {
            $error = 'Das Revisionsurteil darf nicht leer sein.';
        } else {
            $updatedCase = $caseData;
            
            // Status nach Urteil setzen
            $updatedCase['status'] = $revisionVerdictStatus;
            $updatedCase['revision_verdict'] = $revisionVerdictText;
            $updatedCase['revision_verdict_date'] = $revisionVerdictDate;
            $updatedCase['revision_verdict_by'] = $username;
            $updatedCase['revision_completed_date'] = date('Y-m-d H:i:s');
            
            // Notiz zum Fall hinzufügen
            $verdictNote = "Revisionsurteil eingegeben von " . $username . " am " . date('d.m.Y H:i:s') . "\n";
            $verdictNote .= "Urteilsstatus: " . mapStatusToGerman($revisionVerdictStatus) . "\n\n";
            $verdictNote .= $revisionVerdictText;
            
            $updatedCase['notes'] = (!empty($updatedCase['notes'])) 
                ? $verdictNote . "\n\n" . $updatedCase['notes'] 
                : $verdictNote;
            
            if (updateRecord('cases.json', $caseId, $updatedCase)) {
                $message = 'Revisionsurteil wurde erfolgreich hinzugefügt.';
                $caseData = $updatedCase;
                
                // Weiterleitung zur Fallansicht nach erfolgreichem Hinzufügen des Urteils
                header('Location: case_view.php?id=' . $caseId);
                exit;
            } else {
                $error = 'Fehler beim Hinzufügen des Revisionsurteils.';
            }
        }
    }
}

// Vorbereitung der Klageschriftvorlage
$indictmentTemplate = '';
if (!$existingIndictment) {
    $dateFormatted = date('d.m.Y');
    $indictmentTemplate = "Klageschrift

Angeklagter: {$caseData['defendant']}
Anklage: {$caseData['charge']}
Vorfalldatum: " . formatDate($caseData['incident_date'], 'd.m.Y') . "
Bezirk: {$caseData['district']}

SACHVERHALT:
[Beschreiben Sie hier den Sachverhalt]

TATBESTAND:
[Beschreiben Sie hier den Tatbestand]

BEGRÜNDUNG:
[Geben Sie hier die rechtliche Begründung an]

ANTRAG:
Der Angeklagte, {$caseData['defendant']}, wird wegen {$caseData['charge']} angeklagt.

Datum: {$dateFormatted}

{{SIGNATURE}}
(Staatsanwalt)";
}

include '../includes/header.php';
?>

<div class="container-fluid">
    <div class="row">
        <?php include '../includes/sidebar.php'; ?>

        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Fall bearbeiten</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group mr-2">
                        <a href="cases.php" class="btn btn-sm btn-outline-secondary">Zurück zur Fallübersicht</a>
                    </div>
                </div>
            </div>

            <?php if (!empty($message)): ?>
                <div class="alert alert-success"><?php echo htmlspecialchars($message); ?></div>
            <?php endif; ?>
            
            <?php if (!empty($error)): ?>
                <div class="alert alert-danger"><?php echo htmlspecialchars($error); ?></div>
            <?php endif; ?>

            <!-- Fall-Informationen -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Fallinformationen</h4>
                    <button type="button" class="btn btn-outline-primary btn-sm" data-toggle="modal" data-target="#editCaseIDModal">
                        <span data-feather="edit"></span> Aktenzeichen bearbeiten
                    </button>
                </div>
                <div class="card-body">
                    <?php if (isset($error) && $error): ?>
                        <div class="alert alert-danger"><?php echo htmlspecialchars($error); ?></div>
                    <?php endif; ?>
                    
                    <?php if (isset($message) && $message): ?>
                        <div class="alert alert-success"><?php echo htmlspecialchars($message); ?></div>
                    <?php endif; ?>
                    
                    <?php if (isset($showCloseForm) && $showCloseForm): ?>
                    <!-- Formular zum Schließen des Falls -->
                    <div class="alert alert-warning">
                        <h5>Sie sind dabei, diesen Fall zu schließen</h5>
                        <p>Bitte geben Sie einen Grund für die Schließung des Falls an.</p>
                        
                        <form method="post" action="">
                            <input type="hidden" name="action" value="close_case">
                            <div class="form-group">
                                <label for="closing_reason">Grund für die Schließung</label>
                                <textarea class="form-control" id="closing_reason" name="closing_reason" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-danger">Fall schließen</button>
                            <a href="case_view.php?id=<?php echo $caseId; ?>" class="btn btn-secondary">Abbrechen</a>
                        </form>
                    </div>
                    <?php else: ?>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Aktenzeichen:</strong> <?php echo htmlspecialchars($caseData['id']); ?></p>
                            <p><strong>Angeklagter:</strong> <?php echo htmlspecialchars($caseData['defendant']); ?></p>
                            <p><strong>Anklage:</strong> <?php echo htmlspecialchars($caseData['charge']); ?></p>
                            <p><strong>Vorfalldatum:</strong> <?php echo formatDate($caseData['incident_date'], 'd.m.Y'); ?></p>
                            <p><strong>Bezirk:</strong> <?php echo htmlspecialchars($caseData['district']); ?></p>
                        </div>
                        
                        <div class="col-md-6">
                            <p><strong>Status:</strong> 
                                <?php
                                $statusText = mapStatusToGerman($caseData['status']);
                                $statusClass = 'secondary';
                                switch($caseData['status']) {
                                    case 'open': $statusClass = 'info'; break;
                                    case 'in_progress': $statusClass = 'primary'; break;
                                    case 'pending': $statusClass = 'warning'; break;
                                    case 'accepted': $statusClass = 'success'; break;
                                    case 'scheduled': $statusClass = 'primary'; break;
                                    case 'completed': $statusClass = 'dark'; break;
                                    case 'rejected': $statusClass = 'danger'; break;
                                    case 'dismissed': $statusClass = 'secondary'; break;
                                    case 'revision_requested': $statusClass = 'warning'; break;
                                }
                                echo '<span class="badge badge-' . $statusClass . '">' . $statusText . '</span>';
                                ?>
                            </p>
                            <p><strong>Staatsanwalt:</strong> <?php echo htmlspecialchars($caseData['prosecutor'] ?? 'Nicht zugewiesen'); ?></p>
                            <p><strong>Richter:</strong> <?php echo htmlspecialchars($caseData['judge'] ?? 'Nicht zugewiesen'); ?></p>
                            <p><strong>Erstellt am:</strong> <?php echo formatDate($caseData['date_created'], 'd.m.Y H:i'); ?></p>
                            <?php if (isset($caseData['date_updated'])): ?>
                                <p><strong>Zuletzt aktualisiert:</strong> <?php echo formatDate($caseData['date_updated'], 'd.m.Y H:i'); ?></p>
                            <?php endif; ?>
                        </div>
                    </div>
                    <?php if (!empty($caseData['notes'])): ?>
                        <div class="mt-3">
                            <h5>Notizen</h5>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <pre class="mb-0" style="font-family: inherit; white-space: pre-wrap;"><?php echo htmlspecialchars($caseData['notes']); ?></pre>
                                </div>
                            </div>
                        </div>
                    <?php endif; ?>
                </div>
            </div>

            <!-- Tabs für verschiedene Aktionen -->
            <ul class="nav nav-tabs" id="caseTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="edit-tab" data-toggle="tab" href="#edit" role="tab" aria-controls="edit" aria-selected="true">Fall bearbeiten</a>
                </li>
                <?php if (!$existingIndictment && ($role === 'Staatsanwalt' || $role === 'Administrator')): ?>
                    <li class="nav-item">
                        <a class="nav-link" id="indictment-tab" data-toggle="tab" href="#indictment" role="tab" aria-controls="indictment" aria-selected="false">Klageschrift einreichen</a>
                    </li>
                <?php endif; ?>
                <?php if ($existingIndictment): ?>
                    <li class="nav-item">
                        <a class="nav-link" id="view-indictment-tab" data-toggle="tab" href="#view-indictment" role="tab" aria-controls="view-indictment" aria-selected="false">Klageschrift ansehen</a>
                    </li>
                <?php endif; ?>
                <?php if (($caseData['status'] === 'open' || $caseData['status'] === 'in_progress' || $caseData['status'] === 'pending') && ($role === 'Staatsanwalt' || $role === 'Administrator')): ?>
                    <li class="nav-item">
                        <a class="nav-link" id="settlement-tab" data-toggle="tab" href="#settlement" role="tab" aria-controls="settlement" aria-selected="false">Außergerichtlicher Deal</a>
                    </li>
                <?php endif; ?>
                <?php 
                // Staatsanwälte und Führungskräfte dürfen Fälle schließen
                $userRole = $_SESSION['role']; 
                $isProsecutor = strpos(strtolower($userRole), 'prosecutor') !== false 
                            || strpos(strtolower($userRole), 'attorney') !== false;
                $isLeadership = in_array(strtolower($userRole), ['chief_justice', 'senior_associate_justice', 'attorney_general']);
                
                if ($caseData['status'] !== 'completed' && $caseData['status'] !== 'dismissed' && 
                    ($role === 'Administrator' || $role === 'Richter' || $isProsecutor || $isLeadership)): 
                ?>
                    <li class="nav-item">
                        <a class="nav-link" id="close-tab" data-toggle="tab" href="#close" role="tab" aria-controls="close" aria-selected="false">Fall schließen</a>
                    </li>
                <?php endif; ?>
                <?php if (($caseData['status'] === 'completed' || $caseData['status'] === 'rejected') && ($role === 'Staatsanwalt' || $role === 'Administrator')): ?>
                    <li class="nav-item">
                        <a class="nav-link" id="revision-tab" data-toggle="tab" href="#revision" role="tab" aria-controls="revision" aria-selected="false">Revision beantragen</a>
                    </li>
                <?php endif; ?>
                <?php if (strpos($caseData['status'], 'revision') !== false && ($role === 'Richter' || $role === 'Administrator')): ?>
                    <li class="nav-item">
                        <a class="nav-link" id="revision_verdict-tab" data-toggle="tab" href="#revision_verdict" role="tab" aria-controls="revision_verdict" aria-selected="false">Revisionsurteil</a>
                    </li>
                <?php endif; ?>
            </ul>
            
            <div class="tab-content" id="caseTabsContent">
                <!-- Tab: Fall bearbeiten -->
                <div class="tab-pane fade show active" id="edit" role="tabpanel" aria-labelledby="edit-tab">
                    <div class="card border-top-0 rounded-top-0">
                        <div class="card-body">
                            <form method="post" action="">
                                <input type="hidden" name="action" value="update_case">
                                
                                <div class="form-group">
                                    <label for="defendant">Angeklagter *</label>
                                    <input type="text" class="form-control" id="defendant" name="defendant" value="<?php echo htmlspecialchars($caseData['defendant']); ?>" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="charge">Anklage *</label>
                                    <input type="text" class="form-control" id="charge" name="charge" value="<?php echo htmlspecialchars($caseData['charge']); ?>" required>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="incident_date">Vorfalldatum *</label>
                                        <input type="date" class="form-control" id="incident_date" name="incident_date" value="<?php echo htmlspecialchars($caseData['incident_date']); ?>" required>
                                    </div>
                                    
                                    <div class="form-group col-md-6">
                                        <label for="district">Bezirk *</label>
                                        <select class="form-control" id="district" name="district" required>
                                            <option value="">-- Bitte wählen --</option>
                                            <option value="Ost" <?php if ($caseData['district'] === 'Ost') echo 'selected'; ?>>Ost</option>
                                            <option value="West" <?php if ($caseData['district'] === 'West') echo 'selected'; ?>>West</option>
                                            <option value="Nord" <?php if ($caseData['district'] === 'Nord') echo 'selected'; ?>>Nord</option>
                                            <option value="Süd" <?php if ($caseData['district'] === 'Süd') echo 'selected'; ?>>Süd</option>
                                            <option value="Zentral" <?php if ($caseData['district'] === 'Zentral') echo 'selected'; ?>>Zentral</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="prosecutor">Staatsanwalt</label>
                                        <input type="text" class="form-control" id="prosecutor" name="prosecutor" value="<?php echo htmlspecialchars($caseData['prosecutor'] ?? ''); ?>">
                                    </div>
                                    
                                    <div class="form-group col-md-6">
                                        <label for="judge">Richter</label>
                                        <input type="text" class="form-control" id="judge" name="judge" value="<?php echo htmlspecialchars($caseData['judge'] ?? ''); ?>">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="bail_amount">Kaution ($ Dollar)</label>
                                    <input type="number" class="form-control" id="bail_amount" name="bail_amount" value="<?php echo htmlspecialchars($caseData['bail_amount'] ?? ''); ?>">
                                </div>
                                
                                <div class="form-group">
                                    <label for="witnesses">Zeugen (mit TG-Nr.)</label>
                                    <textarea class="form-control" id="witnesses" name="witnesses" rows="3"><?php echo htmlspecialchars($caseData['witnesses'] ?? ''); ?></textarea>
                                    <small class="form-text text-muted">Format: Name, TG-Nr. (Ein Zeuge pro Zeile)</small>
                                </div>

                                <div class="form-group">
                                    <label for="victims">Geschädigte (mit TG-Nr.)</label>
                                    <textarea class="form-control" id="victims" name="victims" rows="3"><?php echo htmlspecialchars($caseData['victims'] ?? ''); ?></textarea>
                                    <small class="form-text text-muted">Format: Name, TG-Nr. (Ein Geschädigter pro Zeile)</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="notes">Notizen</label>
                                    <textarea class="form-control" id="notes" name="notes" rows="4"><?php echo htmlspecialchars($caseData['notes'] ?? ''); ?></textarea>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">Fall aktualisieren</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Klageschrift einreichen -->
                <?php if (!$existingIndictment && ($role === 'Staatsanwalt' || $role === 'Administrator')): ?>
                    <div class="tab-pane fade" id="indictment" role="tabpanel" aria-labelledby="indictment-tab">
                        <div class="card border-top-0 rounded-top-0">
                            <div class="card-body">
                                <form method="post" action="">
                                    <input type="hidden" name="action" value="submit_indictment">
                                    
                                    <div class="form-group">
                                        <label for="indictment_text">Klageschrift *</label>
                                        <textarea class="form-control" id="indictment_text" name="indictment_text" rows="15" required><?php echo htmlspecialchars($indictmentTemplate); ?></textarea>
                                        <small class="form-text text-muted">
                                            Verwenden Sie {{SIGNATURE}} als Platzhalter für Ihre Signatur.
                                        </small>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary">Klageschrift einreichen</button>
                                </form>
                            </div>
                        </div>
                    </div>
                <?php endif; ?>
                
                <!-- Tab: Klageschrift ansehen -->
                <?php if ($existingIndictment): ?>
                    <div class="tab-pane fade" id="view-indictment" role="tabpanel" aria-labelledby="view-indictment-tab">
                        <div class="card border-top-0 rounded-top-0">
                            <div class="card-body">
                                <div class="mb-3">
                                    <h5>Status: 
                                        <?php 
                                            $indictmentStatusText = mapStatusToGerman($existingIndictment['status']);
                                            $indictmentStatusClass = 'secondary';
                                            switch($existingIndictment['status']) {
                                                case 'pending': $indictmentStatusClass = 'warning'; break;
                                                case 'accepted': $indictmentStatusClass = 'success'; break;
                                                case 'scheduled': $indictmentStatusClass = 'primary'; break;
                                                case 'completed': $indictmentStatusClass = 'dark'; break;
                                                case 'rejected': $indictmentStatusClass = 'danger'; break;
                                            }
                                            echo '<span class="badge badge-' . $indictmentStatusClass . '">' . $indictmentStatusText . '</span>';
                                        ?>
                                    </h5>
                                    <p>Eingereicht von: <?php echo htmlspecialchars($existingIndictment['prosecutor_name']); ?></p>
                                    <p>Eingereicht am: <?php echo formatDate($existingIndictment['date_created'], 'd.m.Y H:i'); ?></p>
                                    
                                    <?php if (isset($existingIndictment['processor_name'])): ?>
                                        <p>Bearbeitet von: <?php echo htmlspecialchars($existingIndictment['processor_name']); ?></p>
                                        <p>Bearbeitet am: <?php echo formatDate($existingIndictment['process_date'], 'd.m.Y H:i'); ?></p>
                                    <?php endif; ?>
                                    
                                    <?php if (isset($existingIndictment['trial_date'])): ?>
                                        <p>Verhandlungstermin: <?php echo formatDate($existingIndictment['trial_date'], 'd.m.Y H:i'); ?></p>
                                    <?php endif; ?>
                                    
                                    <?php if (isset($existingIndictment['judgment']) && !empty($existingIndictment['judgment'])): ?>
                                        <h5>Begründung / Anmerkungen:</h5>
                                        <div class="card bg-light mb-3">
                                            <div class="card-body">
                                                <pre class="mb-0" style="font-family: inherit; white-space: pre-wrap;"><?php echo htmlspecialchars($existingIndictment['judgment']); ?></pre>
                                            </div>
                                        </div>
                                    <?php endif; ?>
                                </div>
                                
                                <h5>Inhalt der Klageschrift:</h5>
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <pre class="mb-0" style="font-family: inherit; white-space: pre-wrap;"><?php echo htmlspecialchars($existingIndictment['content']); ?></pre>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <a href="../modules/indictments.php?id=<?php echo $existingIndictment['id']; ?>&view=detail" class="btn btn-primary">
                                        Zur Klageschrift-Detailansicht
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                <?php endif; ?>
                
                <!-- Tab: Außergerichtlicher Deal -->
                <?php if (($caseData['status'] === 'open' || $caseData['status'] === 'in_progress' || $caseData['status'] === 'pending') && ($role === 'Staatsanwalt' || $role === 'Administrator')): ?>
                    <div class="tab-pane fade" id="settlement" role="tabpanel" aria-labelledby="settlement-tab">
                        <div class="card border-top-0 rounded-top-0">
                            <div class="card-body">
                                <div class="alert alert-warning">
                                    <strong>Achtung:</strong> Ein außergerichtlicher Deal wird den Fall abschließen und als erledigt markieren.
                                </div>
                                
                                <form method="post" action="" onsubmit="return confirm('Sind Sie sicher, dass Sie einen außergerichtlichen Deal registrieren möchten? Diese Aktion schließt den Fall ab.');">
                                    <input type="hidden" name="action" value="settlement">
                                    
                                    <div class="form-group">
                                        <label for="settlement_details">Details des außergerichtlichen Deals *</label>
                                        <textarea class="form-control" id="settlement_details" name="settlement_details" rows="6" required></textarea>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-warning">Außergerichtlichen Deal registrieren</button>
                                </form>
                            </div>
                        </div>
                    </div>
                <?php endif; ?>
                
                <!-- Tab: Fall schließen -->
                <?php if ($caseData['status'] !== 'completed' && $caseData['status'] !== 'dismissed' && ($role === 'Administrator' || $role === 'Richter')): ?>
                    <div class="tab-pane fade" id="close" role="tabpanel" aria-labelledby="close-tab">
                        <div class="card border-top-0 rounded-top-0">
                            <div class="card-body">
                                <div class="alert alert-danger">
                                    <strong>Achtung:</strong> Durch das Schließen des Falls wird dieser als erledigt markiert und kann nicht mehr bearbeitet werden.
                                </div>
                                
                                <form method="post" action="" onsubmit="return confirm('Sind Sie sicher, dass Sie diesen Fall schließen möchten? Diese Aktion kann nicht rückgängig gemacht werden.');">
                                    <input type="hidden" name="action" value="close_case">
                                    
                                    <div class="form-group">
                                        <label for="closing_reason">Grund für die Schließung *</label>
                                        <select class="form-control" id="closing_reason" name="closing_reason" required>
                                            <option value="">-- Bitte wählen --</option>
                                            <option value="Eingestellt - mangelnde Beweise">Eingestellt - mangelnde Beweise</option>
                                            <option value="Eingestellt - kein öffentliches Interesse">Eingestellt - kein öffentliches Interesse</option>
                                            <option value="Übertragung an andere Gerichtsbarkeit">Übertragung an andere Gerichtsbarkeit</option>
                                            <option value="Zusammenlegung mit anderem Fall">Zusammenlegung mit anderem Fall</option>
                                            <option value="Administrativer Fehler">Administrativer Fehler</option>
                                            <option value="Sonstiges">Sonstiges</option>
                                        </select>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-danger">Fall schließen</button>
                                </form>
                            </div>
                        </div>
                    </div>
                <?php endif; ?>
                
                <!-- Tab: Revision beantragen -->
                <?php if (($caseData['status'] === 'completed' || $caseData['status'] === 'rejected') && ($role === 'Staatsanwalt' || $role === 'Administrator')): ?>
                    <div class="tab-pane fade" id="revision" role="tabpanel" aria-labelledby="revision-tab">
                        <div class="card border-top-0 rounded-top-0">
                            <div class="card-body">
                                <form method="post" action="">
                                    <input type="hidden" name="action" value="request_revision">
                                    
                                    <div class="form-group">
                                        <label for="revision_reason">Grund für die Revision *</label>
                                        <textarea class="form-control" id="revision_reason" name="revision_reason" rows="6" required></textarea>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-warning">Revision beantragen</button>
                                </form>
                            </div>
                        </div>
                    </div>
                <?php endif; ?>
                
                <!-- Tab: Revisionsurteil eintragen (nur für Richter und Administrator) -->
                <?php if (strpos($caseData['status'], 'revision') !== false && ($role === 'Richter' || $role === 'Administrator')): ?>
                    <div class="tab-pane fade" id="revision_verdict" role="tabpanel" aria-labelledby="revision_verdict-tab">
                        <div class="card border-top-0 rounded-top-0">
                            <div class="card-body">
                                <form method="post" action="">
                                    <input type="hidden" name="action" value="add_revision_verdict">
                                    
                                    <div class="form-group">
                                        <label for="revision_verdict_text">Revisionsurteil *</label>
                                        <textarea class="form-control" id="revision_verdict_text" name="revision_verdict_text" rows="6" required></textarea>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="revision_verdict_date">Urteilsdatum</label>
                                        <input type="date" class="form-control" id="revision_verdict_date" name="revision_verdict_date" value="<?php echo date('Y-m-d'); ?>">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="revision_verdict_status">Fallstatus nach Urteil</label>
                                        <select class="form-control" id="revision_verdict_status" name="revision_verdict_status">
                                            <option value="completed">Abgeschlossen</option>
                                            <option value="reopened">Fall wieder geöffnet</option>
                                        </select>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-success">Revisionsurteil speichern</button>
                                </form>
                            </div>
                        </div>
                    </div>
                <?php endif; ?>
            </div>
        </main>
    </div>
</div>

<!-- Modal für die Bearbeitung des Aktenzeichens -->
<div class="modal fade" id="editCaseIDModal" tabindex="-1" aria-labelledby="editCaseIDModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCaseIDModalLabel">Aktenzeichen bearbeiten</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="post" action="">
                <input type="hidden" name="action" value="update_case_id">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>Achtung:</strong> Das Ändern des Aktenzeichens kann zu Konsistenzproblemen führen. 
                        Stellen Sie sicher, dass das neue Aktenzeichen einzigartig ist.
                    </div>
                    <div class="form-group">
                        <label for="current_case_id">Aktuelles Aktenzeichen</label>
                        <input type="text" class="form-control" id="current_case_id" value="<?php echo htmlspecialchars($caseData['id']); ?>" readonly>
                    </div>
                    <div class="form-group">
                        <label for="new_case_id">Neues Aktenzeichen *</label>
                        <input type="text" class="form-control" id="new_case_id" name="new_case_id" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Aktenzeichen aktualisieren</button>
                </div>
            </form>
        </div>
    </div>
</div>

<?php include '../includes/footer.php'; ?>